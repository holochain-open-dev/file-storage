(self.webpackChunk_holochain_open_dev_file_storage_dev=self.webpackChunk_holochain_open_dev_file_storage_dev||[]).push([[668],{"./stories/upload-files.stories.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{Demo:()=>Demo,__namedExportsOrder:()=>__namedExportsOrder,default:()=>upload_files_stories});var lit_html=__webpack_require__("./node_modules/lit-html/lit-html.js"),tslib_es6=__webpack_require__("./node_modules/tslib/tslib.es6.js"),lit=__webpack_require__("./node_modules/lit/index.js"),decorators=__webpack_require__("./node_modules/lit/decorators.js"),dist=__webpack_require__("./node_modules/@scoped-elements/dropzone/dist/index.js"),context=__webpack_require__("./node_modules/@lit-labs/context/index.js"),elements_dist=__webpack_require__("./node_modules/@holochain-open-dev/elements/dist/index.js"),lit_localize=__webpack_require__("./node_modules/@lit/localize/lit-localize.js"),dist_context=__webpack_require__("./ui/dist/context.js"),holochain_dropzone=__webpack_require__("./ui/dist/holochain-dropzone.js");let UploadFiles=class UploadFiles extends dist.Q{constructor(){super(...arguments),this.required=!1,this.disabled=!1,this.oneFile=!1,this.acceptedFiles=void 0,this._controller=new elements_dist.xf(this)}async firstUpdated(){if(super.firstUpdated(),void 0!==this.defaultValue)if(Array.isArray(this.defaultValue))for(const fileHash of this.defaultValue){const image=await this._client.downloadFile(fileHash);this.dropzone.addFile(image)}else{const image=await this._client.downloadFile(this.defaultValue);this.dropzone.addFile(image)}}reset(){this.clear()}get value(){return this.oneFile?this.dropzone.files[0]?this.dropzone.files[0].hash:void 0:this.dropzone.files.map((file=>file.hash))}reportValidity(){const invalid=!1!==this.required&&void 0===this.value;return invalid&&(this._input.setCustomValidity("Uploading a file is required"),this._input.reportValidity()),!invalid}buildDropzone(dropzoneElement,options){return new holochain_dropzone.z(dropzoneElement,this._client,options)}render(){return lit.dy`
      <div style="position: relative; flex: 1">
        <input
          id="hidden-input"
          style="width:0; height: 0; position: absolute; z-index: -1; left: 50%; top: 20%"
        />
        ${super.render()}
      </div>
    `}};(0,tslib_es6.gn)([(0,decorators.Cb)()],UploadFiles.prototype,"name",void 0),(0,tslib_es6.gn)([(0,decorators.Cb)()],UploadFiles.prototype,"required",void 0),(0,tslib_es6.gn)([(0,decorators.Cb)()],UploadFiles.prototype,"disabled",void 0),(0,tslib_es6.gn)([(0,decorators.Cb)()],UploadFiles.prototype,"defaultValue",void 0),(0,tslib_es6.gn)([(0,decorators.Cb)({type:Boolean,attribute:"one-file"})],UploadFiles.prototype,"oneFile",void 0),(0,tslib_es6.gn)([(0,decorators.Cb)({type:String,attribute:"accepted-files"})],UploadFiles.prototype,"acceptedFiles",void 0),(0,tslib_es6.gn)([(0,context.F_)({context:dist_context.H})],UploadFiles.prototype,"_client",void 0),(0,tslib_es6.gn)([(0,decorators.IO)("#hidden-input")],UploadFiles.prototype,"_input",void 0),UploadFiles=(0,tslib_es6.gn)([(0,lit_localize.kI)(),(0,decorators.Mo)("upload-files")],UploadFiles);__webpack_require__("./ui/dist/elements/file-storage-context.js");var mocks=__webpack_require__("./ui/dist/mocks.js"),ui_dist=__webpack_require__("./ui/dist/index.js");const mock=new mocks.w,upload_files_stories={title:"Frontend/Elements/upload-files",tags:["autodocs"],component:"upload-files",render:args=>lit_html.dy`<file-storage-context .client=${new ui_dist.W5(mock)}>
      <upload-files></upload-files>
    </file-storage-context>`},Demo={};Demo.parameters={...Demo.parameters,docs:{...Demo.parameters?.docs,source:{originalSource:"{}",...Demo.parameters?.docs?.source}}};const __namedExportsOrder=["Demo"]},"./ui/dist/context.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{H:()=>fileStorageClientContext});const fileStorageClientContext=(0,__webpack_require__("./node_modules/@lit-labs/context/index.js").kr)("hc_zome_file_storage/file-storage-client")},"./ui/dist/elements/file-storage-context.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";var tslib__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./node_modules/tslib/tslib.es6.js"),lit__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/lit/index.js"),_lit_labs_context__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/@lit-labs/context/index.js"),lit_decorators_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/lit/decorators.js"),_context_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./ui/dist/context.js");let FileStorageContext=class FileStorageContext extends lit__WEBPACK_IMPORTED_MODULE_0__.oi{render(){return lit__WEBPACK_IMPORTED_MODULE_0__.dy`<slot></slot>`}};FileStorageContext.styles=lit__WEBPACK_IMPORTED_MODULE_0__.iv`
    :host {
      display: contents;
    }
  `,(0,tslib__WEBPACK_IMPORTED_MODULE_4__.gn)([(0,_lit_labs_context__WEBPACK_IMPORTED_MODULE_1__.JJ)({context:_context_js__WEBPACK_IMPORTED_MODULE_3__.H}),(0,lit_decorators_js__WEBPACK_IMPORTED_MODULE_2__.Cb)({type:Object})],FileStorageContext.prototype,"client",void 0),FileStorageContext=(0,tslib__WEBPACK_IMPORTED_MODULE_4__.gn)([(0,lit_decorators_js__WEBPACK_IMPORTED_MODULE_2__.Mo)("file-storage-context")],FileStorageContext)},"./ui/dist/holochain-dropzone.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{z:()=>HolochainDropzone});var _scoped_elements_dropzone__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/@scoped-elements/dropzone/dist/index.js");class HolochainDropzone extends _scoped_elements_dropzone__WEBPACK_IMPORTED_MODULE_0__.f{constructor(el,fileStorageClient,options){options.url="https://holochain.org/",super(el,options),this.fileStorageClient=fileStorageClient}uploadFiles(files){this._uploadFilesToHolochain(files)}async _uploadFilesToHolochain(dropzoneFiles){for(const file of dropzoneFiles)try{this.emit("sending",file,void 0,void 0);const hash=await this.fileStorageClient.uploadFile(file,((percentatge,bytesSent)=>{this.emit("uploadprogress",file,100*percentatge,bytesSent)}));this.emit("success",file,void 0),file.hash=hash,this.emit("complete",file)}catch(e){console.error(e),this.emit("error",file,e.data.data)}}}},"./ui/dist/index.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{W5:()=>FileStorageClient});class FileStorageClient{constructor(client,roleName,zomeName="file_storage"){this.client=client,this.roleName=roleName,this.zomeName=zomeName}async uploadFile(file,onProgress,chunkSize=262144){const blobs=this._splitFile(file,chunkSize),numberOfChunks=blobs.length,bytesPerChunk=blobs[0].size,chunksHashes=[];for(let i=0;i<blobs.length;i++){const chunkHash=await this._createChunk(blobs[i]);chunksHashes.push(chunkHash),onProgress&&onProgress(1*(i+1)/numberOfChunks,bytesPerChunk*(i+1))}const fileToCreate={name:file.name,size:file.size,file_type:file.type,last_modified:file.lastModified,chunks_hashes:chunksHashes};return await this._callZome("create_file_metadata",fileToCreate)}async downloadFile(fileHash){const metadata=await this.getFileMetadata(fileHash),fetchChunksPromises=metadata.chunks_hashes.map((hash=>this.fetchChunk(hash))),chunks=await Promise.all(fetchChunksPromises);return new File(chunks,metadata.name,{lastModified:metadata.last_modifed,type:metadata.file_type})}async getFileMetadata(fileHash){return await this._callZome("get_file_metadata",fileHash)}async fetchChunk(fileChunkHash){const bytes=await this._callZome("get_file_chunk",fileChunkHash);return new Blob([new Uint8Array(bytes)])}_splitFile(file,chunkSize){let offset=0;const chunks=[];for(;file.size>offset;){const chunk=file.slice(offset,offset+chunkSize);offset+=chunkSize,chunks.push(chunk)}return chunks}async _createChunk(chunk){const bytes=await chunk.arrayBuffer();return this._callZome("create_file_chunk",new Uint8Array(bytes))}_callZome(fn_name,payload){const req={role_name:this.roleName,zome_name:this.zomeName,fn_name,payload};return this.client.callZome(req)}}__webpack_require__("./ui/dist/holochain-dropzone.js"),__webpack_require__("./ui/dist/context.js")},"./ui/dist/mocks.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{w:()=>FileStorageZomeMock});var _holochain_open_dev_utils__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/@holochain-open-dev/utils/dist/index.js");class FileStorageZomeMock extends _holochain_open_dev_utils__WEBPACK_IMPORTED_MODULE_0__.a1{constructor(){super(...arguments),this.metadata=new _holochain_open_dev_utils__WEBPACK_IMPORTED_MODULE_0__._d,this.chunks=new _holochain_open_dev_utils__WEBPACK_IMPORTED_MODULE_0__._d}create_file_metadata(fileMetadata){const newId=(0,_holochain_open_dev_utils__WEBPACK_IMPORTED_MODULE_0__.vp)(fileMetadata,_holochain_open_dev_utils__WEBPACK_IMPORTED_MODULE_0__.k_.ENTRY);return this.metadata.set(newId,fileMetadata),newId}get_file_metadata(fileHash){return this.metadata.get(fileHash)}create_file_chunk(fileChunk){const newId=(0,_holochain_open_dev_utils__WEBPACK_IMPORTED_MODULE_0__.vp)(fileChunk,_holochain_open_dev_utils__WEBPACK_IMPORTED_MODULE_0__.k_.ENTRY);return this.chunks.set(newId,fileChunk),newId}get_file_chunk(fileChunkHash){return this.chunks.get(fileChunkHash)}}},"?dba7":()=>{}}]);
//# sourceMappingURL=upload-files-stories.9d0daf13.iframe.bundle.js.map