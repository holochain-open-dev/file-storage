(self.webpackChunk_holochain_open_dev_file_storage_dev=self.webpackChunk_holochain_open_dev_file_storage_dev||[]).push([[668],{"./stories/upload-files.stories.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{Demo:()=>Demo,__namedExportsOrder:()=>__namedExportsOrder,default:()=>upload_files_stories});var lit_html=__webpack_require__("./node_modules/lit-html/lit-html.js"),tslib_es6=__webpack_require__("./node_modules/tslib/tslib.es6.js"),upload_files=__webpack_require__("./ui/dist/elements/upload-files.js"),decorators=__webpack_require__("./node_modules/lit/decorators.js");let UF=class UF extends upload_files.B{};UF=(0,tslib_es6.gn)([(0,decorators.Mo)("upload-files")],UF);__webpack_require__("./ui/dist/definitions/file-storage-context.js");var mocks=__webpack_require__("./ui/dist/mocks.js"),dist=__webpack_require__("./ui/dist/index.js");const mock=new mocks.w,upload_files_stories=(new dist.W5(mock),{title:"Frontend/Elements/upload-files",tags:["autodocs"],component:"upload-files",render:args=>lit_html.dy`<file-storage-context .client=${new dist.W5(mock)}>
      <upload-files></upload-files>
    </file-storage-context>`}),Demo={};Demo.parameters={...Demo.parameters,docs:{...Demo.parameters?.docs,source:{originalSource:"{}",...Demo.parameters?.docs?.source}}};const __namedExportsOrder=["Demo"]},"./ui/dist/context.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{H:()=>fileStorageClientContext});const fileStorageClientContext=(0,__webpack_require__("./node_modules/@lit-labs/context/index.js").kr)("hc_zome_file_storage/file-storage-client")},"./ui/dist/definitions/file-storage-context.js":(__unused_webpack_module,__unused_webpack___webpack_exports__,__webpack_require__)=>{"use strict";var tslib_es6=__webpack_require__("./node_modules/tslib/tslib.es6.js"),lit=__webpack_require__("./node_modules/lit/index.js"),context=__webpack_require__("./node_modules/@lit-labs/context/index.js"),decorators=__webpack_require__("./node_modules/lit/decorators.js"),dist_context=__webpack_require__("./ui/dist/context.js");class FileStorageContext extends lit.oi{render(){return lit.dy`<slot></slot>`}}FileStorageContext.styles=lit.iv`
    :host {
      display: contents;
    }
  `,(0,tslib_es6.gn)([(0,context.JJ)({context:dist_context.H}),(0,decorators.Cb)({type:Object})],FileStorageContext.prototype,"client",void 0);let FSC=class FSC extends FileStorageContext{};FSC=(0,tslib_es6.gn)([(0,decorators.Mo)("file-storage-context")],FSC)},"./ui/dist/elements/show-image.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{k:()=>ShowImage});var tslib__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__("./node_modules/tslib/tslib.es6.js"),lit__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/lit/index.js"),lit_decorators_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/lit/decorators.js"),_holochain_open_dev_elements__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/@holochain-open-dev/elements/dist/index.js"),_open_wc_scoped_elements__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./node_modules/@open-wc/scoped-elements/index.js"),_lit_labs_context__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./node_modules/@lit-labs/context/index.js"),_lit_labs_task__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("./node_modules/@lit-labs/task/index.js"),_scoped_elements_shoelace__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("./node_modules/@scoped-elements/shoelace/dist/index.js"),js_base64__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("./node_modules/js-base64/base64.mjs"),_context__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("./ui/dist/context.js");class ShowImage extends((0,_open_wc_scoped_elements__WEBPACK_IMPORTED_MODULE_3__.f)(lit__WEBPACK_IMPORTED_MODULE_0__.oi)){constructor(){super(...arguments),this._renderImage=new _lit_labs_task__WEBPACK_IMPORTED_MODULE_5__.iQ(this,(async([fileHash])=>{const file=await this._client.downloadFile(fileHash),data=await file.arrayBuffer();return[file,new Uint8Array(data)]}),(()=>[this.imageHash]))}renderImage(file,data){return lit__WEBPACK_IMPORTED_MODULE_0__.dy`<img src="data:${file.type};base64,${(0,js_base64__WEBPACK_IMPORTED_MODULE_8__.kZ)(data)}" style="flex: 1"></img>`}render(){return this._renderImage.render({complete:([f,d])=>this.renderImage(f,d),pending:()=>lit__WEBPACK_IMPORTED_MODULE_0__.dy`<sl-skeleton effect="pulse" style="flex: 1"></sl-skeleton>`,error:e=>lit__WEBPACK_IMPORTED_MODULE_0__.dy`<display-error .error=${e.data.data}></display-error>`})}static get styles(){return[_holochain_open_dev_elements__WEBPACK_IMPORTED_MODULE_2__.FG,lit__WEBPACK_IMPORTED_MODULE_0__.iv`
        :host {
          display: flex;
          flex: 1;
        }
      `]}static get scopedElements(){return{"sl-skeleton":_scoped_elements_shoelace__WEBPACK_IMPORTED_MODULE_6__.pH,"display-error":_holochain_open_dev_elements__WEBPACK_IMPORTED_MODULE_2__.kC}}}(0,tslib__WEBPACK_IMPORTED_MODULE_9__.gn)([(0,lit_decorators_js__WEBPACK_IMPORTED_MODULE_1__.Cb)((0,_holochain_open_dev_elements__WEBPACK_IMPORTED_MODULE_2__.uA)("image-hash"))],ShowImage.prototype,"imageHash",void 0),(0,tslib__WEBPACK_IMPORTED_MODULE_9__.gn)([(0,_lit_labs_context__WEBPACK_IMPORTED_MODULE_4__.F_)({context:_context__WEBPACK_IMPORTED_MODULE_7__.H})],ShowImage.prototype,"_client",void 0)},"./ui/dist/elements/upload-files.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{B:()=>UploadFiles});var tslib__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("./node_modules/tslib/tslib.es6.js"),lit__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/lit/index.js"),lit_decorators_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/lit/decorators.js"),_open_wc_scoped_elements__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/@open-wc/scoped-elements/index.js"),_scoped_elements_dropzone__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./node_modules/@scoped-elements/dropzone/dist/index.js"),_lit_labs_context__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./node_modules/@lit-labs/context/index.js"),_holochain_open_dev_elements__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("./node_modules/@holochain-open-dev/elements/dist/index.js"),_holochain_dropzone__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("./ui/dist/holochain-dropzone.js"),_context__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("./ui/dist/context.js");class UploadFiles extends((0,_open_wc_scoped_elements__WEBPACK_IMPORTED_MODULE_2__.f)(lit__WEBPACK_IMPORTED_MODULE_0__.oi)){constructor(){super(...arguments),this.oneFile=!1,this.acceptedFiles=void 0}firstUpdated(){const client=this._client;this.defineScopedElement("drop-zone",class extends _scoped_elements_dropzone__WEBPACK_IMPORTED_MODULE_3__.Q{buildDropzone(dropzoneElement,options){return new _holochain_dropzone__WEBPACK_IMPORTED_MODULE_6__.z(dropzoneElement,client,options)}})}render(){return lit__WEBPACK_IMPORTED_MODULE_0__.dy`
      <drop-zone
        .oneFile=${this.oneFile}
        .acceptedFiles=${this.acceptedFiles}
        @file-uploaded=${e=>e.detail.hash=e.detail.file.hash}
      ></drop-zone>
    `}static get styles(){return[_holochain_open_dev_elements__WEBPACK_IMPORTED_MODULE_5__.FG,lit__WEBPACK_IMPORTED_MODULE_0__.iv`
        :host {
          display: contents;
        }
      `]}}(0,tslib__WEBPACK_IMPORTED_MODULE_8__.gn)([(0,lit_decorators_js__WEBPACK_IMPORTED_MODULE_1__.Cb)({type:Boolean,attribute:"one-file"})],UploadFiles.prototype,"oneFile",void 0),(0,tslib__WEBPACK_IMPORTED_MODULE_8__.gn)([(0,lit_decorators_js__WEBPACK_IMPORTED_MODULE_1__.Cb)({type:String,attribute:"accepted-files"})],UploadFiles.prototype,"acceptedFiles",void 0),(0,tslib__WEBPACK_IMPORTED_MODULE_8__.gn)([(0,_lit_labs_context__WEBPACK_IMPORTED_MODULE_4__.F_)({context:_context__WEBPACK_IMPORTED_MODULE_7__.H})],UploadFiles.prototype,"_client",void 0)},"./ui/dist/holochain-dropzone.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{z:()=>HolochainDropzone});var dropzone__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/dropzone/dist/dropzone.js"),dropzone__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(dropzone__WEBPACK_IMPORTED_MODULE_0__);class HolochainDropzone extends(dropzone__WEBPACK_IMPORTED_MODULE_0___default()){constructor(el,fileStorageClient,options){options.url="https://holochain.org/",super(el,options),this.fileStorageClient=fileStorageClient}uploadFiles(files){this._uploadFilesToHolochain(files)}async _uploadFilesToHolochain(dropzoneFiles){for(const file of dropzoneFiles)try{this.emit("sending",file,void 0,void 0);const hash=await this.fileStorageClient.uploadFile(file,((percentatge,bytesSent)=>{this.emit("uploadprogress",file,100*percentatge,bytesSent)}));this.emit("success",file,void 0),file.hash=hash,this.emit("complete",file)}catch(e){console.error(e),this.emit("error",file,e.data.data)}}}},"./ui/dist/index.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{W5:()=>FileStorageClient});__webpack_require__("./ui/dist/elements/upload-files.js"),__webpack_require__("./ui/dist/elements/show-image.js");class FileStorageClient{constructor(client,roleName,zomeName="file_storage"){this.client=client,this.roleName=roleName,this.zomeName=zomeName}async uploadFile(file,onProgress,chunkSize=262144){const blobs=this._splitFile(file,chunkSize),numberOfChunks=blobs.length,bytesPerChunk=blobs[0].size,chunksHashes=[];for(let i=0;i<blobs.length;i++){const chunkHash=await this._createChunk(blobs[i]);chunksHashes.push(chunkHash),onProgress&&onProgress(1*(i+1)/numberOfChunks,bytesPerChunk*(i+1))}const fileToCreate={name:file.name,size:file.size,file_type:file.type,last_modified:file.lastModified,chunks_hashes:chunksHashes};return await this._callZome("create_file_metadata",fileToCreate)}async downloadFile(fileHash){const metadata=await this.getFileMetadata(fileHash),fetchChunksPromises=metadata.chunks_hashes.map((hash=>this.fetchChunk(hash))),chunks=await Promise.all(fetchChunksPromises);return new File(chunks,metadata.name,{lastModified:metadata.last_modifed,type:metadata.file_type})}async getFileMetadata(fileHash){return await this._callZome("get_file_metadata",fileHash)}async fetchChunk(fileChunkHash){const bytes=await this._callZome("get_file_chunk",fileChunkHash);return new Blob([new Uint8Array(bytes)])}_splitFile(file,chunkSize){let offset=0;const chunks=[];for(;file.size>offset;){const chunk=file.slice(offset,offset+chunkSize);offset+=chunkSize,chunks.push(chunk)}return chunks}async _createChunk(chunk){const bytes=await chunk.arrayBuffer();return this._callZome("create_file_chunk",new Uint8Array(bytes))}_callZome(fn_name,payload){const req={role_name:this.roleName,zome_name:this.zomeName,fn_name,payload};return this.client.callZome(req)}}__webpack_require__("./ui/dist/holochain-dropzone.js"),__webpack_require__("./ui/dist/context.js")},"./ui/dist/mocks.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{w:()=>FileStorageZomeMock});var _holochain_open_dev_utils__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/@holochain-open-dev/utils/dist/index.js");class FileStorageZomeMock extends _holochain_open_dev_utils__WEBPACK_IMPORTED_MODULE_0__.a1{constructor(){super(...arguments),this.metadata=new _holochain_open_dev_utils__WEBPACK_IMPORTED_MODULE_0__._d,this.chunks=new _holochain_open_dev_utils__WEBPACK_IMPORTED_MODULE_0__._d}create_file_metadata(fileMetadata){const newId=(0,_holochain_open_dev_utils__WEBPACK_IMPORTED_MODULE_0__.vp)(fileMetadata,_holochain_open_dev_utils__WEBPACK_IMPORTED_MODULE_0__.k_.ENTRY);return this.metadata.set(newId,fileMetadata),newId}get_file_metadata(fileHash){return this.metadata.get(fileHash)}create_file_chunk(fileChunk){const newId=(0,_holochain_open_dev_utils__WEBPACK_IMPORTED_MODULE_0__.vp)(fileChunk,_holochain_open_dev_utils__WEBPACK_IMPORTED_MODULE_0__.k_.ENTRY);return this.chunks.set(newId,fileChunk),newId}get_file_chunk(fileChunkHash){return this.chunks.get(fileChunkHash)}}},"?dba7":()=>{}}]);
//# sourceMappingURL=upload-files-stories.755cb6ee.iframe.bundle.js.map