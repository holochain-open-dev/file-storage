{"version":3,"file":"initializer_decorators_test.js","sourceRoot":"","sources":["../../../src/test/decorators/initializer_decorators_test.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * @license\n * Copyright 2017 Google LLC\n * SPDX-License-Identifier: BSD-3-Clause\n */\n\nimport {ReactiveElement} from '../../reactive-element.js';\nimport {generateElementName} from '../test-helpers.js';\nimport {decorateProperty} from '../../decorators/base.js';\nimport {assert} from '@esm-bundle/chai';\nimport {property} from '../../decorators/property.js';\n\nsuite('Decorators using initializers', () => {\n  let container: HTMLDivElement;\n\n  setup(async () => {\n    container = document.createElement('div');\n    document.body.appendChild(container);\n  });\n\n  teardown(() => {\n    container.parentElement!.removeChild(container);\n  });\n\n  test('can create initializer decorator with `decorateProperty`', async () => {\n    const wasDecorated = (value: string) =>\n      decorateProperty({\n        finisher: (ctor: typeof ReactiveElement, name: PropertyKey) => {\n          ctor.addInitializer((e: A) => {\n            // eslint-disable-next-line @typescript-eslint/no-explicit-any\n            (e as any).decoration = {name, value};\n          });\n        },\n      });\n\n    class A extends ReactiveElement {\n      @wasDecorated('bar')\n      foo?: string;\n    }\n    customElements.define(generateElementName(), A);\n    const el = new A();\n    container.appendChild(el);\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    assert.deepEqual((el as any).decoration, {name: 'foo', value: 'bar'});\n  });\n\n  test('can create `listen` controller decorator', async () => {\n    const listeners: WeakMap<\n      ReactiveElement,\n      Array<{type: string; listener: (e: Event) => void}>\n    > = new WeakMap();\n    const listenWindow = <T>(type: string) => {\n      return decorateProperty({\n        finisher: (ctor: typeof ReactiveElement, name: PropertyKey) => {\n          ctor.addInitializer((e: ReactiveElement) => {\n            const listener = (event: Event) =>\n              ((((ctor.prototype as unknown) as T)[\n                name as keyof T\n              ] as unknown) as Function).call(e, event);\n            let l = listeners.get(e);\n            if (l === undefined) {\n              listeners.set(e, (l = []));\n              e.addController({\n                hostConnected() {\n                  l!.forEach((info) => {\n                    window.addEventListener(info.type, info.listener);\n                  });\n                },\n                hostDisconnected() {\n                  l!.forEach((info) => {\n                    window.removeEventListener(info.type, info.listener);\n                  });\n                },\n              });\n            }\n            l.push({type, listener});\n          });\n        },\n      });\n    };\n\n    class B extends ReactiveElement {\n      @listenWindow<B>('nug')\n      eventHandler1(e: Event) {\n        this.event1 = e.type;\n      }\n      @listenWindow<B>('zug')\n      eventHandler2(e: Event) {\n        this.event2 = e.type;\n      }\n      event1?: string;\n      event2?: string;\n    }\n    customElements.define(generateElementName(), B);\n    const el = new B();\n    container.appendChild(el);\n    document.body.dispatchEvent(new Event('nug', {bubbles: true}));\n    document.body.dispatchEvent(new Event('zug', {bubbles: true}));\n    assert.equal(el.event1, 'nug');\n    assert.equal(el.event2, 'zug');\n    el.event1 = undefined;\n    el.event2 = undefined;\n    container.removeChild(el);\n    document.body.dispatchEvent(new Event('nug', {bubbles: true}));\n    document.body.dispatchEvent(new Event('zug', {bubbles: true}));\n    assert.isUndefined(el.event1);\n    assert.isUndefined(el.event2);\n  });\n\n  test('can create `validate` controller decorator', async () => {\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    type Validator = (v: any) => any;\n\n    const validators: WeakMap<\n      ReactiveElement,\n      Array<{key: PropertyKey; validator: Validator}>\n    > = new WeakMap();\n\n    const validate = <T>(validatorFn: Validator) => {\n      return decorateProperty({\n        finisher: (ctor: typeof ReactiveElement, name: PropertyKey) => {\n          ctor.addInitializer((e: ReactiveElement) => {\n            let v = validators.get(e);\n            if (v === undefined) {\n              validators.set(e, (v = []));\n              e.addController({\n                hostUpdate() {\n                  v!.forEach(({key, validator}) => {\n                    ((e as unknown) as T)[key as keyof T] = validator(\n                      ((e as unknown) as T)[key as keyof T]\n                    );\n                  });\n                },\n              });\n            }\n            v.push({key: name, validator: validatorFn});\n          });\n        },\n      });\n    };\n\n    class B extends ReactiveElement {\n      @property()\n      @validate<B>((v: number) => Math.max(0, Math.min(10, v)))\n      foo = 5;\n    }\n    customElements.define(generateElementName(), B);\n    const el = new B();\n    container.appendChild(el);\n    await el.updateComplete;\n    assert.equal(el.foo, 5);\n    el.foo = 100;\n    await el.updateComplete;\n    assert.equal(el.foo, 10);\n    el.foo = -100;\n    await el.updateComplete;\n    assert.equal(el.foo, 0);\n  });\n\n  test('can create `observer` controller decorator', async () => {\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    type Observer = (value: any, previous?: any) => void;\n\n    const observers: WeakMap<\n      ReactiveElement,\n      Array<{key: PropertyKey; observer: Observer; previousValue?: any}>\n    > = new WeakMap();\n\n    const observer = <T>(observerFn: Observer) => {\n      return decorateProperty({\n        finisher: (ctor: typeof ReactiveElement, name: PropertyKey) => {\n          ctor.addInitializer((e: ReactiveElement) => {\n            let v = observers.get(e);\n            if (v === undefined) {\n              observers.set(e, (v = []));\n              e.addController({\n                hostUpdated() {\n                  v!.forEach((info) => {\n                    const value = ((e as unknown) as T)[info.key as keyof T];\n                    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n                    const hasChanged =\n                      (e.constructor as any).getPropertyOptions(name)\n                        ?.hasChanged ?? Object.is;\n                    if (hasChanged(value, info.previousValue)) {\n                      info.observer.call(e, value, info.previousValue);\n                      info.previousValue = value;\n                    }\n                  });\n                },\n              });\n            }\n            v.push({key: name, observer: observerFn});\n          });\n        },\n      });\n    };\n\n    class B extends ReactiveElement {\n      @property()\n      @observer<B>(function (this: B, value: number, previous?: number) {\n        this._observedFoo = {value, previous};\n      })\n      foo = 5;\n      _observedFoo?: {value: number; previous?: number};\n\n      @property()\n      @observer<B>(function (this: B, value: string, previous?: string) {\n        this._observedBar = {value, previous};\n      })\n      bar = 'bar';\n      _observedBar?: {value: string; previous?: string};\n    }\n    customElements.define(generateElementName(), B);\n    const el = new B();\n    container.appendChild(el);\n    await el.updateComplete;\n    assert.deepEqual(el._observedFoo, {value: 5, previous: undefined});\n    assert.deepEqual(el._observedBar, {value: 'bar', previous: undefined});\n    el.foo = 100;\n    el.bar = 'bar2';\n    await el.updateComplete;\n    assert.deepEqual(el._observedFoo, {value: 100, previous: 5});\n    assert.deepEqual(el._observedBar, {value: 'bar2', previous: 'bar'});\n  });\n});\n"]}