"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.v8ToIstanbul = void 0;
const path_1 = require("path");
const v8_to_istanbul_1 = __importDefault(require("v8-to-istanbul"));
const picomatch_1 = __importDefault(require("picomatch"));
const utils_1 = require("./utils");
const cachedMatchers = new Map();
// coverage base dir must be separated with "/"
const coverageBaseDir = process.cwd().split(path_1.sep).join('/');
function getMatcher(patterns) {
    if (!patterns || patterns.length === 0) {
        return () => true;
    }
    const key = patterns.join('');
    let matcher = cachedMatchers.get(key);
    if (!matcher) {
        const resolvedPatterns = patterns.map(pattern => !path_1.isAbsolute(pattern) && !pattern.startsWith('*')
            ? path_1.posix.join(coverageBaseDir, pattern)
            : pattern);
        matcher = picomatch_1.default(resolvedPatterns);
        cachedMatchers.set(key, matcher);
    }
    return matcher;
}
async function v8ToIstanbul(config, testFiles, coverage) {
    var _a, _b;
    const included = getMatcher((_a = config === null || config === void 0 ? void 0 : config.coverageConfig) === null || _a === void 0 ? void 0 : _a.include);
    const excluded = getMatcher((_b = config === null || config === void 0 ? void 0 : config.coverageConfig) === null || _b === void 0 ? void 0 : _b.exclude);
    const istanbulCoverage = {};
    for (const entry of coverage) {
        const path = new URL(entry.url).pathname;
        if (!!path_1.extname(path) && !path.startsWith('/__web-test-runner__/')) {
            const filePath = path_1.join(config.rootDir, utils_1.toFilePath(path));
            if ((await utils_1.fileExists(filePath)) &&
                !testFiles.includes(filePath) &&
                included(filePath) &&
                !excluded(filePath)) {
                const converter = v8_to_istanbul_1.default(filePath, 0, entry.source ? { source: entry.source } : undefined);
                await converter.load();
                converter.applyCoverage(entry.functions);
                Object.assign(istanbulCoverage, converter.toIstanbul());
            }
        }
    }
    return istanbulCoverage;
}
exports.v8ToIstanbul = v8ToIstanbul;
//# sourceMappingURL=index.js.map